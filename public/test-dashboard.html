<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>System Test Dashboard - Disciplined Disciples</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body class="bg-gray-100">
    <div class="container mx-auto px-4 py-8">
        <h1 class="text-3xl font-bold text-center mb-8">System Test Dashboard</h1>
        
        <!-- Test Status Cards -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">Authentication</p>
                        <p class="text-2xl font-bold" id="auth-status">Testing...</p>
                    </div>
                    <div class="text-blue-600">
                        <i class="fas fa-user-shield text-2xl"></i>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">Database</p>
                        <p class="text-2xl font-bold" id="db-status">Testing...</p>
                    </div>
                    <div class="text-green-600">
                        <i class="fas fa-database text-2xl"></i>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">Email System</p>
                        <p class="text-2xl font-bold" id="email-status">Testing...</p>
                    </div>
                    <div class="text-yellow-600">
                        <i class="fas fa-envelope text-2xl"></i>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">PayFast</p>
                        <p class="text-2xl font-bold" id="payfast-status">Testing...</p>
                    </div>
                    <div class="text-purple-600">
                        <i class="fas fa-credit-card text-2xl"></i>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Test Controls -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-8">
            <h2 class="text-xl font-bold mb-4">Test Controls</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                <button onclick="testAuthentication()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors">
                    <i class="fas fa-user-check mr-2"></i>Test Auth
                </button>
                <button onclick="testDatabase()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors">
                    <i class="fas fa-database mr-2"></i>Test Database
                </button>
                <button onclick="testProfile()" class="bg-yellow-600 text-white px-4 py-2 rounded-lg hover:bg-yellow-700 transition-colors">
                    <i class="fas fa-user mr-2"></i>Test Profile
                </button>
                <button onclick="testOrders()" class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition-colors">
                    <i class="fas fa-shopping-cart mr-2"></i>Test Orders
                </button>
                <button onclick="testPayment()" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition-colors">
                    <i class="fas fa-credit-card mr-2"></i>Test Payment
                </button>
                <button onclick="testEmail()" class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 transition-colors">
                    <i class="fas fa-envelope mr-2"></i>Test Email
                </button>
                <button onclick="testSupport()" class="bg-pink-600 text-white px-4 py-2 rounded-lg hover:bg-pink-700 transition-colors">
                    <i class="fas fa-headset mr-2"></i>Test Support
                </button>
                <button onclick="runAllTests()" class="bg-gray-800 text-white px-4 py-2 rounded-lg hover:bg-gray-900 transition-colors">
                    <i class="fas fa-play mr-2"></i>Run All Tests
                </button>
            </div>
        </div>
        
        <!-- Test Results -->
        <div class="bg-white rounded-lg shadow-md p-6">
            <h2 class="text-xl font-bold mb-4">Test Results</h2>
            <div id="test-results" class="space-y-4">
                <p class="text-gray-500">Click a test button to see results here...</p>
            </div>
        </div>
        
        <!-- System Health Monitor -->
        <div class="bg-white rounded-lg shadow-md p-6 mt-8">
            <h2 class="text-xl font-bold mb-4">System Health Monitor</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="text-center">
                    <div class="text-3xl font-bold text-green-500" id="uptime">99.9%</div>
                    <p class="text-gray-600">Uptime</p>
                </div>
                <div class="text-center">
                    <div class="text-3xl font-bold text-blue-500" id="response-time">245ms</div>
                    <p class="text-gray-600">Avg Response Time</p>
                </div>
                <div class="text-center">
                    <div class="text-3xl font-bold text-purple-500" id="active-users">42</div>
                    <p class="text-gray-600">Active Users</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBVpuDI_YJI7mxtT6-igSL7ZX3s-cqMRnc",
            authDomain: "disciplined-disciples-1.firebaseapp.com",
            projectId: "disciplined-disciples-1",
            storageBucket: "disciplined-disciples-1.firebasestorage.app",
            messagingSenderId: "565996965931",
            appId: "1:565996965931:web:b9d18489caa790e7afda6e",
            measurementId: "G-2J1GWH59V4"
        };

        // Initialize Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        let testResults = [];

        function addTestResult(test, status, message, details = null) {
            const timestamp = new Date().toLocaleTimeString();
            const result = { test, status, message, details, timestamp };
            testResults.unshift(result);
            updateTestResults();
        }

        function updateTestResults() {
            const container = document.getElementById('test-results');
            container.innerHTML = testResults.map(result => `
                <div class="border-l-4 ${result.status === 'success' ? 'border-green-500 bg-green-50' : 
                             result.status === 'error' ? 'border-red-500 bg-red-50' : 
                             'border-yellow-500 bg-yellow-50'} p-4 rounded">
                    <div class="flex justify-between items-start">
                        <div>
                            <h4 class="font-semibold ${result.status === 'success' ? 'text-green-800' : 
                                                     result.status === 'error' ? 'text-red-800' : 'text-yellow-800'}">
                                ${result.test}
                            </h4>
                            <p class="text-gray-700">${result.message}</p>
                            ${result.details ? `<pre class="text-xs text-gray-600 mt-2 bg-white p-2 rounded">${JSON.stringify(result.details, null, 2)}</pre>` : ''}
                        </div>
                        <span class="text-xs text-gray-500">${result.timestamp}</span>
                    </div>
                </div>
            `).join('');
        }

        async function testAuthentication() {
            try {
                addTestResult('Authentication', 'info', 'Testing Firebase Auth...');
                
                // Test anonymous auth first
                const userCredential = await auth.signInAnonymously();
                addTestResult('Authentication', 'success', 'Anonymous authentication successful', {
                    uid: userCredential.user.uid
                });
                
                document.getElementById('auth-status').textContent = 'Passed';
                document.getElementById('auth-status').className = 'text-2xl font-bold text-green-600';
                
                // Sign out
                await auth.signOut();
                
            } catch (error) {
                addTestResult('Authentication', 'error', `Authentication failed: ${error.message}`, error);
                document.getElementById('auth-status').textContent = 'Failed';
                document.getElementById('auth-status').className = 'text-2xl font-bold text-red-600';
            }
        }

        async function testDatabase() {
            try {
                addTestResult('Database', 'info', 'Testing Firestore connection...');
                
                // Test write
                const testDoc = db.collection('test').doc('connectivity');
                await testDoc.set({
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    test: 'connectivity'
                });
                
                // Test read
                const doc = await testDoc.get();
                if (doc.exists) {
                    addTestResult('Database', 'success', 'Firestore read/write test passed', doc.data());
                    document.getElementById('db-status').textContent = 'Passed';
                    document.getElementById('db-status').className = 'text-2xl font-bold text-green-600';
                } else {
                    throw new Error('Document not found after write');
                }
                
                // Clean up
                await testDoc.delete();
                
            } catch (error) {
                addTestResult('Database', 'error', `Database test failed: ${error.message}`, error);
                document.getElementById('db-status').textContent = 'Failed';
                document.getElementById('db-status').className = 'text-2xl font-bold text-red-600';
            }
        }

        async function testProfile() {
            try {
                addTestResult('Profile System', 'info', 'Testing profile functionality...');
                
                // Sign in anonymously for testing
                const userCredential = await auth.signInAnonymously();
                const userId = userCredential.user.uid;
                
                // Create test profile
                const profileData = {
                    name: 'Test User',
                    email: 'test@disciplineddisciples.com',
                    phone: '+27123456789',
                    address: {
                        line1: '123 Test Street',
                        city: 'Cape Town',
                        province: 'Western Cape',
                        postalCode: '8001'
                    },
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                await db.collection('artifacts').doc('default-app-id')
                    .collection('users').doc(userId).set(profileData);
                
                // Read back profile
                const profileDoc = await db.collection('artifacts').doc('default-app-id')
                    .collection('users').doc(userId).get();
                
                if (profileDoc.exists) {
                    addTestResult('Profile System', 'success', 'Profile creation and retrieval successful', profileDoc.data());
                } else {
                    throw new Error('Profile not found after creation');
                }
                
                // Clean up
                await profileDoc.ref.delete();
                await auth.signOut();
                
            } catch (error) {
                addTestResult('Profile System', 'error', `Profile test failed: ${error.message}`, error);
            }
        }

        async function testOrders() {
            try {
                addTestResult('Order System', 'info', 'Testing order management...');
                
                // Sign in anonymously for testing
                const userCredential = await auth.signInAnonymously();
                const userId = userCredential.user.uid;
                
                // Create test order
                const orderData = {
                    userId: userId,
                    items: [
                        {
                            name: 'Test Product',
                            price: 299.99,
                            quantity: 1,
                            size: 'M',
                            color: 'Black'
                        }
                    ],
                    totalAmount: 379.99, // Including shipping
                    status: 'Processing',
                    orderDate: firebase.firestore.FieldValue.serverTimestamp(),
                    deliveryAddress: {
                        line1: '123 Test Street',
                        city: 'Cape Town',
                        province: 'Western Cape',
                        postalCode: '8001'
                    }
                };
                
                const orderRef = await db.collection('artifacts').doc('default-app-id')
                    .collection('orders').add(orderData);
                
                // Read back order
                const orderDoc = await orderRef.get();
                
                if (orderDoc.exists) {
                    addTestResult('Order System', 'success', 'Order creation and retrieval successful', {
                        orderId: orderDoc.id,
                        ...orderDoc.data()
                    });
                } else {
                    throw new Error('Order not found after creation');
                }
                
                // Clean up
                await orderRef.delete();
                await auth.signOut();
                
            } catch (error) {
                addTestResult('Order System', 'error', `Order test failed: ${error.message}`, error);
            }
        }

        async function testPayment() {
            try {
                addTestResult('Payment System', 'info', 'Testing PayFast integration...');
                
                // Test PayFast parameters generation
                const testOrder = {
                    id: 'test-order-123',
                    totalAmount: 299.99,
                    items: [{ name: 'Test Product', quantity: 1 }]
                };
                
                const payfastParams = {
                    merchant_id: '10004002', // Test merchant ID
                    merchant_key: 'q1cd2rdny4a53', // Test merchant key
                    amount: testOrder.totalAmount.toFixed(2),
                    item_name: `Disciplined Disciples Order #${testOrder.id}`,
                    return_url: `${window.location.origin}/profile.html?payment=success`,
                    cancel_url: `${window.location.origin}/cart.html?payment=cancelled`
                };
                
                // Validate required parameters
                const requiredParams = ['merchant_id', 'merchant_key', 'amount', 'item_name'];
                const missingParams = requiredParams.filter(param => !payfastParams[param]);
                
                if (missingParams.length > 0) {
                    throw new Error(`Missing required PayFast parameters: ${missingParams.join(', ')}`);
                }
                
                addTestResult('Payment System', 'success', 'PayFast parameter generation successful', payfastParams);
                document.getElementById('payfast-status').textContent = 'Ready';
                document.getElementById('payfast-status').className = 'text-2xl font-bold text-green-600';
                
            } catch (error) {
                addTestResult('Payment System', 'error', `Payment test failed: ${error.message}`, error);
                document.getElementById('payfast-status').textContent = 'Failed';
                document.getElementById('payfast-status').className = 'text-2xl font-bold text-red-600';
            }
        }

        async function testEmail() {
            try {
                addTestResult('Email System', 'info', 'Testing email configuration...');
                
                // Test email template generation
                const testOrder = {
                    id: 'test-order-123',
                    totalAmount: 299.99,
                    items: [
                        {
                            name: 'Test Product',
                            price: 299.99,
                            quantity: 1,
                            size: 'M',
                            color: 'Black'
                        }
                    ],
                    customerEmail: 'test@example.com',
                    orderDate: new Date()
                };
                
                // Generate email template
                const emailTemplate = `
                    <h2>Order Confirmation</h2>
                    <p>Thank you for your order!</p>
                    <p>Order #: ${testOrder.id}</p>
                    <p>Total: R${testOrder.totalAmount.toFixed(2)}</p>
                    <p>Items: ${testOrder.items.length}</p>
                `;
                
                if (emailTemplate.includes(testOrder.id) && emailTemplate.includes(testOrder.totalAmount.toFixed(2))) {
                    addTestResult('Email System', 'success', 'Email template generation successful', {
                        template: emailTemplate.substring(0, 200) + '...'
                    });
                    document.getElementById('email-status').textContent = 'Ready';
                    document.getElementById('email-status').className = 'text-2xl font-bold text-green-600';
                } else {
                    throw new Error('Email template generation failed validation');
                }
                
            } catch (error) {
                addTestResult('Email System', 'error', `Email test failed: ${error.message}`, error);
                document.getElementById('email-status').textContent = 'Failed';
                document.getElementById('email-status').className = 'text-2xl font-bold text-red-600';
            }
        }

        async function testSupport() {
            try {
                addTestResult('Support System', 'info', 'Testing support functionality...');
                
                // Sign in anonymously for testing
                const userCredential = await auth.signInAnonymously();
                const userId = userCredential.user.uid;
                
                // Create test support request
                const supportRequest = {
                    userId: userId,
                    userEmail: 'test@example.com',
                    userName: 'Test User',
                    subject: 'Test Support Request',
                    message: 'This is a test support request to verify the system is working.',
                    status: 'Open',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                const supportRef = await db.collection('artifacts').doc('default-app-id')
                    .collection('support-requests').add(supportRequest);
                
                // Read back support request
                const supportDoc = await supportRef.get();
                
                if (supportDoc.exists) {
                    addTestResult('Support System', 'success', 'Support request creation successful', {
                        requestId: supportDoc.id,
                        subject: supportDoc.data().subject
                    });
                } else {
                    throw new Error('Support request not found after creation');
                }
                
                // Clean up
                await supportRef.delete();
                await auth.signOut();
                
            } catch (error) {
                addTestResult('Support System', 'error', `Support test failed: ${error.message}`, error);
            }
        }

        async function runAllTests() {
            addTestResult('System Test', 'info', 'Starting comprehensive system test...');
            
            const tests = [
                testAuthentication,
                testDatabase,
                testProfile,
                testOrders,
                testPayment,
                testEmail,
                testSupport
            ];
            
            for (const test of tests) {
                try {
                    await test();
                    // Add delay between tests
                    await new Promise(resolve => setTimeout(resolve, 1000));
                } catch (error) {
                    console.error(`Test failed:`, error);
                }
            }
            
            addTestResult('System Test', 'success', 'Comprehensive system test completed');
        }

        // Initialize test dashboard
        document.addEventListener('DOMContentLoaded', () => {
            addTestResult('System Initialize', 'success', 'Test dashboard loaded successfully');
            
            // Update system health metrics periodically
            setInterval(() => {
                document.getElementById('uptime').textContent = `${(99.9 + Math.random() * 0.1).toFixed(1)}%`;
                document.getElementById('response-time').textContent = `${Math.floor(200 + Math.random() * 100)}ms`;
                document.getElementById('active-users').textContent = Math.floor(40 + Math.random() * 20);
            }, 5000);
        });
    </script>
</body>
</html>
