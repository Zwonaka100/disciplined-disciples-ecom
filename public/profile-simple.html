<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profile - Disciplined Disciples</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
</head>
<body class="bg-gray-50">
    <!-- Loading overlay -->
    <div id="loading-overlay" class="fixed inset-0 bg-white bg-opacity-90 flex items-center justify-center z-50">
        <div class="text-center">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"></div>
            <p class="text-gray-600">Loading profile...</p>
        </div>
    </div>

    <!-- Header -->
    <header class="bg-white shadow-sm">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center py-4">
                <div class="flex items-center">
                    <img src="Assets/logo.jpg" alt="Disciplined Disciples" class="h-8 w-8 rounded-full">
                    <span class="ml-2 text-xl font-bold text-gray-900">Disciplined Disciples</span>
                </div>
                <nav class="flex space-x-4">
                    <a href="index.html" class="text-gray-600 hover:text-gray-900">Home</a>
                    <a href="shop.html" class="text-gray-600 hover:text-gray-900">Shop</a>
                    <a href="profile.html" class="text-blue-600 font-medium">Profile</a>
                    <button id="logout-btn" class="text-red-600 hover:text-red-700">
                        <i class="fas fa-sign-out-alt mr-1"></i>Logout
                    </button>
                </nav>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
        <!-- Profile Header -->
        <div class="bg-gradient-to-r from-blue-600 to-purple-600 rounded-lg p-8 mb-8 text-white">
            <div class="flex items-center">
                <div id="profile-avatar" class="w-24 h-24 rounded-full bg-white flex items-center justify-center text-gray-800 font-bold text-2xl shadow-lg">
                    ?
                </div>
                <div class="ml-6">
                    <h1 id="profile-name" class="text-3xl font-bold">Loading...</h1>
                    <p id="profile-email" class="text-blue-100">Loading...</p>
                    <p id="profile-joined" class="text-blue-200 text-sm">Member since Loading...</p>
                </div>
            </div>
        </div>

        <!-- Profile Content -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Account Info -->
            <div class="lg:col-span-2">
                <div class="bg-white rounded-lg shadow p-6">
                    <h2 class="text-xl font-bold text-gray-900 mb-4">Account Information</h2>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Full Name</label>
                            <input type="text" id="user-name" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm" placeholder="Enter your name">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Email</label>
                            <input type="email" id="user-email" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm" readonly>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Phone</label>
                            <input type="tel" id="user-phone" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm" placeholder="Enter your phone number">
                        </div>
                        
                        <button id="save-profile-btn" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">
                            Save Changes
                        </button>
                    </div>
                </div>
            </div>

            <!-- Stats & Quick Actions -->
            <div class="space-y-6">
                <!-- Stats -->
                <div class="bg-white rounded-lg shadow p-6">
                    <h3 class="text-lg font-medium text-gray-900 mb-4">Account Stats</h3>
                    <div class="space-y-3">
                        <div class="flex justify-between">
                            <span class="text-gray-600">Total Orders</span>
                            <span id="total-orders" class="font-medium">0</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Total Spent</span>
                            <span id="total-spent" class="font-medium">R0.00</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Loyalty Points</span>
                            <span id="loyalty-points" class="font-medium">0</span>
                        </div>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="bg-white rounded-lg shadow p-6">
                    <h3 class="text-lg font-medium text-gray-900 mb-4">Quick Actions</h3>
                    <div class="space-y-3">
                        <a href="order-history.html" class="block w-full text-center bg-gray-100 text-gray-700 py-2 px-4 rounded-md hover:bg-gray-200">
                            <i class="fas fa-history mr-2"></i>Order History
                        </a>
                        <a href="shop.html" class="block w-full text-center bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700">
                            <i class="fas fa-shopping-bag mr-2"></i>Continue Shopping
                        </a>
                        <a href="contact.html" class="block w-full text-center bg-green-600 text-white py-2 px-4 rounded-md hover:bg-green-700">
                            <i class="fas fa-headset mr-2"></i>Contact Support
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Recent Orders -->
        <div class="mt-8 bg-white rounded-lg shadow">
            <div class="px-6 py-4 border-b border-gray-200">
                <h3 class="text-lg font-medium text-gray-900">Recent Orders</h3>
            </div>
            <div id="recent-orders" class="p-6">
                <p class="text-gray-500 text-center">Loading orders...</p>
            </div>
        </div>
    </main>

    <!-- Load script.js and initialize -->
    <script src="script.js"></script>
    <script>
        console.log('ðŸš€ Simple profile page loading...');
        
        let currentUser = null;
        
        // Simple auth check with fallback
        function checkAuth() {
            console.log('Checking authentication...');
            
            // Wait for Firebase
            if (typeof firebase === 'undefined' || !firebase.auth) {
                console.log('Firebase not ready, retrying...');
                setTimeout(checkAuth, 500);
                return;
            }
            
            // Check auth state
            firebase.auth().onAuthStateChanged((user) => {
                console.log('Auth state:', user ? user.email : 'No user');
                
                if (user) {
                    currentUser = user;
                    loadUserProfile(user);
                    hideLoading();
                } else {
                    console.log('No user, redirecting to login...');
                    window.location.href = 'login-signup.html?redirect=profile-simple.html';
                }
            });
        }
        
        // Load user profile data
        function loadUserProfile(user) {
            console.log('Loading profile for:', user.email);
            
            // Update profile header
            document.getElementById('profile-name').textContent = user.displayName || user.email.split('@')[0];
            document.getElementById('profile-email').textContent = user.email;
            document.getElementById('profile-joined').textContent = `Member since ${new Date(user.metadata.creationTime).toLocaleDateString()}`;
            
            // Update avatar
            const avatar = document.getElementById('profile-avatar');
            if (user.photoURL) {
                avatar.innerHTML = `<img src="${user.photoURL}" alt="Profile" class="w-full h-full rounded-full object-cover">`;
            } else {
                avatar.textContent = (user.displayName || user.email)[0].toUpperCase();
            }
            
            // Update form fields
            document.getElementById('user-name').value = user.displayName || '';
            document.getElementById('user-email').value = user.email;
            
            // Load additional data from Firestore
            loadFirestoreData(user.uid);
        }
        
        // Load data from Firestore
        async function loadFirestoreData(userId) {
            try {
                const db = firebase.firestore();
                
                // Try to load user document
                const userDoc = await db.collection('artifacts/default-app-id/users').doc(userId).get();
                
                if (userDoc.exists) {
                    const userData = userDoc.data();
                    console.log('User data loaded:', userData);
                    
                    // Update form with saved data
                    if (userData.name) document.getElementById('user-name').value = userData.name;
                    if (userData.phone) document.getElementById('user-phone').value = userData.phone;
                } else {
                    console.log('No user document found, will create on save');
                }
                
                // Load orders (simplified)
                const ordersQuery = await db.collection('artifacts/default-app-id/orders')
                    .where('userId', '==', userId)
                    .orderBy('orderDate', 'desc')
                    .limit(5)
                    .get();
                
                displayRecentOrders(ordersQuery.docs);
                
            } catch (error) {
                console.error('Error loading Firestore data:', error);
                // Continue without Firestore data
            }
        }
        
        // Display recent orders
        function displayRecentOrders(orders) {
            const container = document.getElementById('recent-orders');
            
            if (orders.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center">No orders yet. <a href="shop.html" class="text-blue-600 hover:underline">Start shopping!</a></p>';
                return;
            }
            
            let ordersHtml = '<div class="space-y-3">';
            orders.forEach(orderDoc => {
                const order = orderDoc.data();
                ordersHtml += `
                    <div class="border rounded-lg p-4">
                        <div class="flex justify-between items-start">
                            <div>
                                <h4 class="font-medium">Order #${orderDoc.id.substring(0, 8)}</h4>
                                <p class="text-sm text-gray-600">${new Date(order.orderDate?.toDate()).toLocaleDateString()}</p>
                            </div>
                            <div class="text-right">
                                <p class="font-medium">R${order.total?.toFixed(2) || '0.00'}</p>
                                <span class="text-xs px-2 py-1 rounded ${getStatusClass(order.status)}">${order.status || 'pending'}</span>
                            </div>
                        </div>
                    </div>
                `;
            });
            ordersHtml += '</div>';
            
            container.innerHTML = ordersHtml;
            
            // Update stats
            document.getElementById('total-orders').textContent = orders.length;
            const totalSpent = orders.reduce((sum, doc) => sum + (doc.data().total || 0), 0);
            document.getElementById('total-spent').textContent = `R${totalSpent.toFixed(2)}`;
        }
        
        // Get status class for styling
        function getStatusClass(status) {
            switch (status) {
                case 'delivered': return 'bg-green-100 text-green-800';
                case 'shipped': return 'bg-blue-100 text-blue-800';
                case 'processing': return 'bg-yellow-100 text-yellow-800';
                default: return 'bg-gray-100 text-gray-800';
            }
        }
        
        // Save profile
        async function saveProfile() {
            if (!currentUser) return;
            
            try {
                const name = document.getElementById('user-name').value;
                const phone = document.getElementById('user-phone').value;
                
                const db = firebase.firestore();
                
                await db.collection('artifacts/default-app-id/users').doc(currentUser.uid).set({
                    name: name,
                    phone: phone,
                    email: currentUser.email,
                    updatedAt: new Date()
                }, { merge: true });
                
                console.log('Profile saved successfully');
                alert('Profile updated successfully!');
                
            } catch (error) {
                console.error('Error saving profile:', error);
                alert('Error saving profile. Please try again.');
            }
        }
        
        // Logout
        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                firebase.auth().signOut().then(() => {
                    window.location.href = 'login-signup.html';
                });
            }
        }
        
        // Hide loading overlay
        function hideLoading() {
            const overlay = document.getElementById('loading-overlay');
            if (overlay) {
                overlay.style.display = 'none';
            }
        }
        
        // Event listeners
        document.addEventListener('DOMContentLoaded', () => {
            console.log('DOM loaded, starting auth check...');
            
            // Set up event listeners
            document.getElementById('save-profile-btn').addEventListener('click', saveProfile);
            document.getElementById('logout-btn').addEventListener('click', logout);
            
            // Start auth check after a short delay to let script.js initialize
            setTimeout(checkAuth, 1000);
        });
    </script>
</body>
</html>