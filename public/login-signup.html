<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Disciplined Disciples - Login / Signup</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="icon" type="image/png" href="Assets/45.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Firebase SDKs -->
     
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <!-- Google Analytics 4 -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-2J1GWH59V4"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-2J1GWH59V4');
    </script>
</head>
<body class="bg-gray-50">
    <!-- Header -->
    <header class="header">
        <div class="container flex justify-between items-center py-4">
            <a href="index.html" class="logo flex items-center">
                <img src="Assets/45.png" alt="Disciplined Disciples Logo" style="height:48px; width:auto; margin-right:10px;">
                <span>Disciplined Disciples</span>
            </a>
            <nav class="nav-menu">
                <ul class="flex space-x-6">
                    <li><a href="index.html" class="nav-link">Home</a></li>
                    <li><a href="shop.html" class="nav-link">Shop</a></li>
                    <li><a href="about.html" class="nav-link">About</a></li>
                    <li><a href="blog.html" class="nav-link">Blog</a></li>
                    <li><a href="contact.html" class="nav-link">Contact</a></li>
                    <li><a href="cart.html" class="nav-link"><i class="fas fa-shopping-cart"></i></a></li>
                </ul>
                <a href="login-signup.html" id="login-signup-link" class="nav-link"><i class="fas fa-sign-in-alt"></i> Login/Signup</a>
                <!-- Standardized Profile Dropdown -->
                <div id="profile-ribbon" class="relative" style="display: none;">
                    <div class="flex items-center space-x-2 cursor-pointer select-none hover:bg-gray-50 rounded-lg px-2 py-1 transition-colors">
                        <span id="profile-ribbon-name" class="font-semibold text-gray-700 text-sm"></span>
                        <div id="profile-ribbon-avatar" class="w-8 h-8 rounded-full flex items-center justify-center bg-gray-200 text-gray-700 font-bold text-xs border-2 border-gray-300 overflow-hidden"></div>
                        <i class="fas fa-chevron-down text-gray-500 text-xs"></i>
                    </div>
                    

                </div>
            </nav>
        </div>
    </header>

    <!-- Profile Dropdown - floating compact dropdown -->
    <div id="profile-dropdown" class="fixed right-4 bg-white border border-gray-200 rounded shadow-lg min-w-[120px] z-[9999] overflow-hidden hidden" style="top: 60px;">
        <div class="py-1">
            <a href="profile.html" class="flex items-center px-3 py-2 text-sm text-gray-700 hover:bg-gray-50 transition-colors">
                <i class="fas fa-user mr-2 text-gray-400"></i>
                Profile
            </a>
            <a href="profile.html#orders" class="flex items-center px-3 py-2 text-sm text-gray-700 hover:bg-gray-50 transition-colors">
                <i class="fas fa-shopping-bag mr-2 text-gray-400"></i>
                Orders
            </a>
            <a href="profile.html#account" class="flex items-center px-3 py-2 text-sm text-gray-700 hover:bg-gray-50 transition-colors">
                <i class="fas fa-cog mr-2 text-gray-400"></i>
                Settings
            </a>
            <div class="border-t border-gray-100"></div>
            <button id="dropdown-logout-btn" class="flex items-center w-full px-3 py-2 text-sm text-red-600 hover:bg-red-50 transition-colors">
                <i class="fas fa-sign-out-alt mr-2 text-red-500"></i>
                Logout
            </button>
        </div>
    </div>

    <!-- Hero Section -->
    <section class="auth-hero-section">
        <div class="container mx-auto px-4 text-center py-16">
            <h1 class="auth-title">Join Our Community</h1>
            <p class="auth-subtitle">Sign in or create an account to unlock exclusive features.</p>
        </div>
    </section>

    <!-- Login/Signup Forms Section -->
    <main class="py-12 px-4">
        <div class="container mx-auto max-w-md">
            <div class="form-container">
                <div class="flex mb-8 border-b border-gray-200">
                    <button id="login-tab" class="flex-1 py-3 text-center text-lg font-semibold text-gray-600 border-b-2 border-transparent hover:border-blue-500 transition-colors duration-300 active-tab">Login</button>
                    <button id="signup-tab" class="flex-1 py-3 text-center text-lg font-semibold text-gray-600 border-b-2 border-transparent hover:border-blue-500 transition-colors duration-300">Sign Up</button>
                </div>
                <!-- Login Form -->
                <div id="login-form-container" class="form-content">
                    <form id="login-form" class="space-y-6">
                        <div>
                            <label for="login-email" class="form-label">Email Address</label>
                            <input type="email" id="login-email" class="form-input" placeholder="you@example.com" required autocomplete="email">
                        </div>
                        <div>
                            <label for="login-password" class="form-label">Password</label>
                            <input type="password" id="login-password" class="form-input" placeholder="••••••••" required autocomplete="current-password">
                        </div>
                        <button type="submit" class="btn btn-primary w-full">Login</button>
                        <p class="text-center text-gray-600 mt-4">Forgot password? <a href="#" class="text-blue-600 hover:underline">Reset it</a></p>
                    </form>
                </div>
                <!-- Signup Form -->
                <div id="signup-form-container" class="form-content hidden">
                    <form id="signup-form" class="space-y-6">
                        <div>
                            <label for="signup-name" class="form-label">Full Name</label>
                            <input type="text" id="signup-name" class="form-input" placeholder="Your full name" required autocomplete="name">
                        </div>
                        <div>
                            <label for="signup-email" class="form-label">Email Address</label>
                            <input type="email" id="signup-email" class="form-input" placeholder="you@example.com" required autocomplete="email">
                        </div>
                        <div>
                            <label for="signup-password" class="form-label">Password</label>
                            <input type="password" id="signup-password" class="form-input" placeholder="•••••••• (min 6 characters)" required autocomplete="new-password">
                        </div>
                        <div>
                            <label for="signup-confirm-password" class="form-label">Confirm Password</label>
                            <input type="password" id="signup-confirm-password" class="form-input" placeholder="••••••••" required autocomplete="new-password">
                        </div>
                        <button type="submit" class="btn btn-primary w-full">Sign Up</button>
                    </form>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="footer bg-gray-800 text-white py-8 mt-12">
        <div class="container mx-auto px-4 grid grid-cols-1 md:grid-cols-4 gap-8">
            <div class="footer-col">
                <h3 class="footer-heading text-xl font-bold mb-4">Disciplined Disciples</h3>
                <p class="footer-text text-gray-300 text-sm">Premium apparel designed to inspire discipline, purpose, and faith.</p>
                <div class="social-links mt-4 flex space-x-4">
                    <a href="https://www.instagram.com/disciplined_disciples_2023/" target="_blank" class="social-link text-gray-400 hover:text-white transition-colors duration-200 text-lg"><i class="fab fa-instagram"></i></a>
                    <a href="#" class="social-link text-gray-400 hover:text-white transition-colors duration-200 text-lg"><i class="fab fa-facebook-f"></i></a>
                    <a href="#" class="social-link text-gray-400 hover:text-white transition-colors duration-200 text-lg"><i class="fab fa-twitter"></i></a>
                </div>
            </div>
            <div class="footer-col">
                <h3 class="footer-heading text-lg font-semibold mb-4">Quick Links</h3>
                <ul>
                    <li class="mb-2"><a href="index.html" class="footer-link text-gray-300 hover:text-white transition-colors duration-200 text-sm">Home</a></li>
                    <li class="mb-2"><a href="shop.html" class="footer-link text-gray-300 hover:text-white transition-colors duration-200 text-sm">Shop</a></li>
                    <li class="mb-2"><a href="blog.html" class="footer-link text-gray-300 hover:text-white transition-colors duration-200 text-sm">Blog</a></li>
                    <li class="mb-2"><a href="contact.html" class="footer-link text-gray-300 hover:text-white transition-colors duration-200 text-sm">Contact</a></li>
                </ul>
            </div>
            <div class="footer-col">
                <h3 class="footer-heading text-lg font-semibold mb-4">Support</h3>
                <ul>
                    <li class="mb-2"><a href="faq.html" class="footer-link text-gray-300 hover:text-white transition-colors duration-200 text-sm">FAQs</a></li>
                    <li class="mb-2"><a href="shipping-returns.html" class="footer-link text-gray-300 hover:text-white transition-colors duration-200 text-sm">Shipping & Returns</a></li>
                    <li class="mb-2"><a href="privacy-policy.html" class="footer-link text-gray-300 hover:text-white transition-colors duration-200 text-sm">Privacy Policy</a></li>
                    <li class="mb-2"><a href="terms-of-service.html" class="footer-link text-gray-300 hover:text-white transition-colors duration-200 text-sm">Terms of Service</a></li>
                </ul>
            </div>
            <div class="footer-col">
                <h3 class="footer-heading text-lg font-semibold mb-4">Contact Us</h3>
                <p class="footer-text text-gray-300 text-sm mb-2">Email: nomaqhizazolile@gmail.com</p>
                <p class="footer-text text-gray-300 text-sm mb-2">Phone: +27 69 206 0618</p>
                <p class="footer-text text-gray-300 text-sm">Johannesburg, South Africa</p>
            </div>
        </div>
        <div class="footer-bottom border-t border-gray-700 mt-8 pt-4 text-center text-gray-500 text-sm">
            <p>&copy; 2025 Disciplined Disciples. All rights reserved.</p>
            <p>Built by <a href="https://zande.io" target="_blank" rel="noopener noreferrer" style="color: #667eea; text-decoration: none; transition: color 0.2s;">Zande Technologies</a> (Pty) Ltd</p>
        </div>
    </footer>

    <script src="script.js"></script>
    <script>
        // Firebase is already initialized in script.js
        document.addEventListener('DOMContentLoaded', async () => {
            // Firebase is now initialized directly in this script
            // Tab switching logic
            const loginTab = document.getElementById('login-tab');
            const signupTab = document.getElementById('signup-tab');
            const loginFormContainer = document.getElementById('login-form-container');
            const signupFormContainer = document.getElementById('signup-form-container');

            loginTab?.addEventListener('click', () => {
                loginTab.classList.add('active-tab');
                signupTab.classList.remove('active-tab');
                loginFormContainer.classList.remove('hidden');
                signupFormContainer.classList.add('hidden');
            });

            signupTab?.addEventListener('click', () => {
                signupTab.classList.add('active-tab');
                loginTab.classList.remove('active-tab');
                signupFormContainer.classList.remove('hidden');
                loginFormContainer.classList.add('hidden');
            });

            // Signup logic
            const signupForm = document.getElementById('signup-form');
            signupForm?.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const nameInput = document.getElementById('signup-name');
                const emailInput = document.getElementById('signup-email');
                const passwordInput = document.getElementById('signup-password');
                const confirmPasswordInput = document.getElementById('signup-confirm-password');
                
                // Get and validate inputs
                const name = nameInput.value.trim();
                const email = emailInput.value.trim();
                const password = passwordInput.value.trim();
                const confirmPassword = confirmPasswordInput.value.trim();
                
                // Clear any previous error states
                [nameInput, emailInput, passwordInput, confirmPasswordInput].forEach(input => {
                    input.classList.remove('border-red-500');
                });
                
                // Validation
                if (!name) {
                    window.showMessage('Please enter your full name.', 'error');
                    nameInput.classList.add('border-red-500');
                    nameInput.focus();
                    return;
                }
                
                if (!email) {
                    window.showMessage('Please enter your email address.', 'error');
                    emailInput.classList.add('border-red-500');
                    emailInput.focus();
                    return;
                }
                
                // Email format validation
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                if (!emailRegex.test(email)) {
                    window.showMessage('Please enter a valid email address.', 'error');
                    emailInput.classList.add('border-red-500');
                    emailInput.focus();
                    return;
                }
                
                if (!password) {
                    window.showMessage('Please enter a password.', 'error');
                    passwordInput.classList.add('border-red-500');
                    passwordInput.focus();
                    return;
                }
                
                if (password.length < 6) {
                    window.showMessage('Password must be at least 6 characters.', 'error');
                    passwordInput.classList.add('border-red-500');
                    passwordInput.focus();
                    return;
                }
                
                if (password !== confirmPassword) {
                    window.showMessage('Passwords do not match.', 'error');
                    confirmPasswordInput.classList.add('border-red-500');
                    confirmPasswordInput.focus();
                    return;
                }
                
                try {
                    // Show loading state
                    const submitBtn = signupForm.querySelector('button[type="submit"]');
                    const originalText = submitBtn.textContent;
                    submitBtn.disabled = true;
                    submitBtn.textContent = 'Creating account...';
                    
                    // Create user account
                    const userCredential = await firebase.auth().createUserWithEmailAndPassword(email, password);
                    const user = userCredential.user;
                    
                    console.log('User created successfully:', user.uid);
                    
                    // Create user profile in Firestore
                    await firebase.firestore().collection('artifacts').doc('default-app-id')
                        .collection('users').doc(user.uid).set({
                            email: user.email,
                            name: name,
                            phone: "",
                            avatarUrl: "",
                            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                            deliveryAddress: {
                                line1: "",
                                line2: "",
                                city: "",
                                province: "",
                                postalCode: ""
                            }
                        });
                    
                    console.log('User profile created in Firestore');
                    
                    window.showMessage('Account created successfully!', 'success');
                    
                    // Reset form
                    signupForm.reset();
                    
                    // Switch to login tab
                    setTimeout(() => {
                        loginTab.click();
                        window.showMessage('You can now log in with your new account.', 'info');
                    }, 1500);
                    
                } catch (error) {
                    console.error('Signup error:', error);
                    
                    // Reset button state
                    const submitBtn = signupForm.querySelector('button[type="submit"]');
                    submitBtn.disabled = false;
                    submitBtn.textContent = originalText;
                    
                    // Show user-friendly error messages
                    let errorMessage = 'Account creation failed. Please try again.';
                    
                    if (error.code === 'auth/email-already-in-use') {
                        errorMessage = 'An account with this email already exists.';
                        emailInput.classList.add('border-red-500');
                    } else if (error.code === 'auth/invalid-email') {
                        errorMessage = 'Invalid email address format.';
                        emailInput.classList.add('border-red-500');
                    } else if (error.code === 'auth/weak-password') {
                        errorMessage = 'Password is too weak. Please choose a stronger password.';
                        passwordInput.classList.add('border-red-500');
                    }
                    
                    window.showMessage(errorMessage, 'error');
                }
            });

            // Login logic
            const loginForm = document.getElementById('login-form');
            loginForm?.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const emailInput = document.getElementById('login-email');
                const passwordInput = document.getElementById('login-password');
                
                // Get and validate inputs
                const email = emailInput.value.trim();
                const password = passwordInput.value.trim();
                
                // Clear any previous error states
                emailInput.classList.remove('border-red-500');
                passwordInput.classList.remove('border-red-500');
                
                // Basic validation
                if (!email) {
                    window.showMessage('Please enter your email address.', 'error');
                    emailInput.classList.add('border-red-500');
                    emailInput.focus();
                    return;
                }
                
                if (!password) {
                    window.showMessage('Please enter your password.', 'error');
                    passwordInput.classList.add('border-red-500');
                    passwordInput.focus();
                    return;
                }
                
                // Email format validation
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                if (!emailRegex.test(email)) {
                    window.showMessage('Please enter a valid email address.', 'error');
                    emailInput.classList.add('border-red-500');
                    emailInput.focus();
                    return;
                }
                
                // Show loading state
                const submitBtn = loginForm.querySelector('button[type="submit"]');
                const originalText = submitBtn.textContent;
                
                try {
                    console.log('Attempting login with email:', email);
                    
                    submitBtn.disabled = true;
                    submitBtn.textContent = 'Signing in...';
                    
                    // Use the correct Firebase auth method
                    const userCredential = await firebase.auth().signInWithEmailAndPassword(email, password);
                    
                    console.log('Login successful for user:', userCredential.user.uid);
                    window.showMessage('Login successful! Redirecting...', 'success');
                    
                    // Set the global user ID immediately
                    window.currentUserId = userCredential.user.uid;
                    
                    // Store user session info for better persistence (both session and local)
                    sessionStorage.setItem('userLoggedIn', 'true');
                    sessionStorage.setItem('userId', userCredential.user.uid);
                    localStorage.setItem('userLoggedIn', 'true');
                    localStorage.setItem('userId', userCredential.user.uid);
                    
                    // Determine redirect target
                    const urlParams = new URLSearchParams(window.location.search);
                    const requestedRedirect = urlParams.get('redirect');
                    const target = (typeof determinePostLoginDestination === 'function')
                        ? determinePostLoginDestination(userCredential.user, requestedRedirect || 'profile.html')
                        : ((requestedRedirect) || (typeof isAdminEmail === 'function' && isAdminEmail(userCredential.user.email) ? 'admin-dashboard.html' : 'profile.html'));

                    let redirectUrl = target;
                    if (!isAdminEmail(userCredential.user.email) && redirectUrl.includes('profile.html') && !redirectUrl.includes('fromLogin=')) {
                        redirectUrl += redirectUrl.includes('?') ? '&fromLogin=true' : '?fromLogin=true';
                    }
                    
                    // Wait a moment for auth state to propagate, then redirect
                    setTimeout(() => {
                        console.log('Redirecting to:', redirectUrl);
                        if (typeof redirectAfterAuthentication === 'function') {
                            redirectAfterAuthentication(userCredential.user, { requestedRedirect: redirectUrl, fallbackUrl: 'profile.html' });
                        } else {
                            window.location.href = redirectUrl;
                        }
                    }, 1200);
                    
                } catch (error) {
                    console.error('Login error:', error);
                    
                    // Reset button state
                    submitBtn.disabled = false;
                    submitBtn.textContent = originalText;
                    
                    // Show user-friendly error messages
                    let errorMessage = 'Login failed. Please try again.';
                    
                    if (error.code === 'auth/user-not-found') {
                        errorMessage = 'No account found with this email address.';
                        emailInput.classList.add('border-red-500');
                    } else if (error.code === 'auth/wrong-password') {
                        errorMessage = 'Incorrect password. Please try again.';
                        passwordInput.classList.add('border-red-500');
                    } else if (error.code === 'auth/invalid-email') {
                        errorMessage = 'Invalid email address format.';
                        emailInput.classList.add('border-red-500');
                    } else if (error.code === 'auth/too-many-requests') {
                        errorMessage = 'Too many failed attempts. Please try again later.';
                    }
                    
                    window.showMessage(errorMessage, 'error');
                }
            });

            // Handle already authenticated users
            // Don't show profile ribbon on login page - redirect if already logged in
            firebase.auth().onAuthStateChanged((user) => {
                if (user) {
                    // Avoid redirect loops: if storage is already set and we arrived from profile, stay put
                    const cameFromProfile = document.referrer && document.referrer.includes('profile.html');
                    const hasSession = (sessionStorage.getItem('userLoggedIn') && sessionStorage.getItem('userId'))
                        || (localStorage.getItem('userLoggedIn') && localStorage.getItem('userId'));

                    if (cameFromProfile && hasSession) {
                        console.log('User authenticated but came from profile with session set — not redirecting');
                        return;
                    }

                    console.log('User already authenticated, redirecting to profile...');
                    // Seed storage to keep consistency
                    sessionStorage.setItem('userLoggedIn', 'true');
                    sessionStorage.setItem('userId', user.uid);
                    localStorage.setItem('userLoggedIn', 'true');
                    localStorage.setItem('userId', user.uid);

                    const urlParams = new URLSearchParams(window.location.search);
                    const requestedRedirect = urlParams.get('redirect');
                    const target = (typeof determinePostLoginDestination === 'function')
                        ? determinePostLoginDestination(user, requestedRedirect || 'profile.html')
                        : ((requestedRedirect) || (typeof isAdminEmail === 'function' && isAdminEmail(user.email) ? 'admin-dashboard.html' : 'profile.html'));

                    if (typeof redirectAfterAuthentication === 'function') {
                        redirectAfterAuthentication(user, { requestedRedirect: target, fallbackUrl: 'profile.html' });
                    } else {
                        window.location.href = target;
                    }
                    return; // Exit early to prevent further execution
                }
            });
            
            // Ensure profile ribbon stays hidden on login page
            const profileRibbon = document.getElementById('profile-ribbon');
            if (profileRibbon) {
                profileRibbon.style.display = 'none';
            }
            
            // Set up profile dropdown functionality (in case it appears later)
            setupProfileDropdownForLoginPage();
        });
        
        function setupProfileDropdownForLoginPage() {
            const profileRibbon = document.getElementById('profile-ribbon');
            const profileDropdown = document.getElementById('profile-dropdown');
            const dropdownLogoutBtn = document.getElementById('dropdown-logout-btn');
            
            // Profile dropdown toggle
            profileRibbon?.addEventListener('click', (e) => {
                e.stopPropagation();
                profileDropdown?.classList.toggle('hidden');
            });
            
            // Close dropdown when clicking outside
            document.addEventListener('click', (e) => {
                if (!profileRibbon?.contains(e.target)) {
                    profileDropdown?.classList.add('hidden');
                }
            });
            
            // Logout functionality
            dropdownLogoutBtn?.addEventListener('click', async () => {
                try {
                    await firebase.auth().signOut();
                    window.showMessage('Logged out successfully!', 'success');
                    // Refresh page to show login form
                    setTimeout(() => {
                        window.location.reload();
                    }, 1000);
                } catch (error) {
                    console.error('Logout error:', error);
                    window.showMessage('Logout failed. Please try again.', 'error');
                }
            });
        }
    </script>

    <!-- WhatsApp Floating Button -->
    <a href="https://wa.me/27692060618?text=Hi%20Disciplined%20Disciples!%20I%20have%20a%20question%20about%20your%20products." 
       class="whatsapp-float" 
       target="_blank" 
       rel="noopener noreferrer"
       aria-label="Chat on WhatsApp">
        <i class="fab fa-whatsapp"></i>
    </a>

    <!-- Cookie Consent Banner (POPIA Compliance) -->
    <div id="cookie-consent-banner" class="cookie-consent-banner">
        <div class="cookie-consent-content">
            <div class="cookie-consent-text">
                <h3>🍪 We Value Your Privacy</h3>
                <p>We use cookies to improve your experience and analyze site traffic. By clicking "Accept", you consent to our use of cookies. <a href="privacy-policy.html">Learn more</a></p>
            </div>
            <div class="cookie-consent-actions">
                <button id="cookie-accept-btn" class="cookie-btn cookie-btn-accept">Accept All Cookies</button>
                <button id="cookie-decline-btn" class="cookie-btn cookie-btn-decline">Decline Analytics</button>
            </div>
        </div>
    </div>
</body>
</html>
